<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="studyGroupMapper">
	<select id="getStudyList" resultType="string">
		select study_name
		from study_category
	</select>
	
	<select id="getBranchList" resultMap="branchResultMap">
		select branch_no, branch_name
		from branch
	</select>
	
	<resultMap id="branchResultMap" type="ViewBranch">
		<id column="BRANCH_NO" property="branchNo"/>
		<result column="BRANCH_NAME" property="branchName"/>
	</resultMap>
	
	<select id="getStudyNo" parameterType="string" resultType="_int">
		select study_no
		from study_category
		where study_name = #{studyname}
	</select>
	
	<insert id="insertGroup" parameterType="StudyGroup">
		insert into sgroup
		values(seq_sgid.nextval, #{sgName}, #{sgGoal}, #{sgContent}, default, #{branchNo}, #{id}, #{studyNo}, default)
	</insert>
	
	<insert id="insertRecruit">
		<if test="recMettingDate != null">
		insert into rec_sgroup
		values(seq_rcid.nextval, #{recTerm}, #{recNum}, sysdate, #{recMettingDate}, seq_sgid.currval)
		</if>
		<if test="recMettingDate == null">
		insert into rec_sgroup
		values(seq_rcid.nextval, #{recTerm}, #{recNum}, sysdate, null, #{sgNo})
		</if>
	</insert>
	
	<select id="getStudyGroup" parameterType="string" resultMap="studyGroupResultSet">
		select sg_no, sg_name
		from sgroup
		where id=#{id} and sg_status='Y'
	</select>
	
	<select id="getStudyGroupRecruit" parameterType="_int" resultMap="groupRecruitResultSet">
		select sg_no, sg_status
		from sgroup
		where sg_no = #{sgno}
	</select>
	
	<select id="getGroupInfoForRec" parameterType="_int" resultMap="groupRecruitResultSet">
		select sg_no, study_name, msg_num, branch_name, msg_met_rule, sg_goal, msg_rule1, msg_rule2, msg_rule3, sg_content
		from sgroup
			join study_category using(study_no)
			join branch using(branch_no)
			join m_sgroup using(sg_no)
		where sg_no = #{sgno}
	</select>
	
	<select id="getIngRecCount" parameterType="_int" resultType="_int">
		select count(*)
		from rec_sgroup
		where sg_no = #{sgno} and TO_DATE(SUBSTR(RSG_TERM, 14), 'YY/MM/DD') >= SYSDATE
	</select>
	
	<select id="getPartMemberNum" parameterType="_int" resultType="_int">
		select count(*)
		from ap_sgroup
		where asg_status = 'Y' and sg_no = #{sgno}
	</select>
	
	<select id="getRecList" resultMap="groupRecruitResultSet">
		select sg_no, rsg_no, study_name, sg_name, (TO_DATE(SUBSTR(RSG_TERM, 14), 'YY/MM/DD') - TRUNC(SYSDATE)) as D_CLOSE_DATE, rsg_num, nick, branch_name, sg_goal, sg_content
		from sgroup g
			right join rec_sgroup r using(sg_no)
		    join study_category using(study_no)
			join branch using(branch_no)
			join member using(id)
		where TO_DATE(SUBSTR(RSG_TERM, 14), 'YY/MM/DD') >= TO_DATE(SYSDATE, 'YY/MM/DD')
	</select>
	
	<select id="getRecCompleteNum" parameterType="_int" resultType="_int">
		select count(*)
		from ap_sgroup
		where rsg_no = #{recNo} and asg_status = 'Y'
	</select>
	
	<select id="getRecListCount" resultType="_int">
		select count(*)
		from sgroup g
			right join rec_sgroup r using(sg_no)
		    join study_category using(study_no)
			join branch using(branch_no)
			join member using(id)
		where TO_DATE(SUBSTR(RSG_TERM, 14), 'YY/MM/DD') >= TO_DATE(SYSDATE, 'YY/MM/DD')
	</select>
	
	<resultMap type="StudyGroupRecruit" id="groupRecruitResultSet">
		<id property="sgNo" column="SG_NO"/>
		<id property="recNo" column="RSG_NO"/>
		<id property="recTerm" column="RSG_TERM"/>
		<id property="dCloseDate" column="D_CLOSE_DATE"/>
		<id property="recNum" column="RSG_NUM"/>
		<id property="nick" column="NICK"/>
		<id property="sgStatus" column="SG_STATUS"/>
		<id property="studyName" column="STUDY_NAME"/>
		<id property="msgNum" column="MSG_NUM"/>
		<id property="branchName" column="BRANCH_NAME"/>
		<id property="msgMetRule" column="MSG_MET_RULE"/>
		<id property="sgName" column="SG_NAME"/>
		<id property="sgStatus" column="SG_STATUS"/>
		<id property="sgGoal" column="SG_GOAL"/>
		<id property="msgRule1" column="MSG_RULE1"/>
		<id property="msgRule2" column="MSG_RULE2"/>
		<id property="msgRule3" column="MSG_RULE3"/>
		<id property="sgContent" column="SG_CONTENT"/>
	</resultMap>
	
	<select id="getStudyGroupInfo" parameterType="_int" resultMap="studyGroupResultSet">
		<!-- select sg_no, sg_name, sg_goal, sg_content, sg_status, branch_no, id, study_name, msg_num, msg_rule1, msg_rule2, msg_rule3, msg_met_rule
	    from sgroup 
	        join m_sgroup using(sg_no)
	        join study_category using(study_no)
	    where sg_no = #{sgno} -->
	    <!-- select distinct sg_no, sg_name, sg_goal, sg_content, sg_status, branch_no, id, study_name, nvl(msg_num, rsg_num) as msg_num, msg_rule1, msg_rule2, msg_rule3, nvl(msg_met_rule, rsg_metting_date) as msg_met_rule
		from sgroup 
		    left join m_sgroup using(sg_no)
		    left join rec_sgroup using(sg_no)
		    join study_category using(study_no)
		where sg_no = #{sgno} -->
		select *
		from (select distinct sg_no, sg_name, sg_goal, sg_content, sg_status, branch_no, id, study_name, nvl(msg_num, rsg_num) as msg_num, msg_rule1, msg_rule2, msg_rule3, nvl(msg_met_rule, rsg_metting_date) as msg_met_rule, rsg_no, substr(rsg_term, 14) as final_rec_date
		        from sgroup 
		            left join m_sgroup using(sg_no)
		            left join rec_sgroup using(sg_no)
		            join study_category using(study_no)
		    where sg_no = #{sgno}
		    order by rsg_no)
		where rownum = 1
	</select>
	
	<resultMap type="StudyGroup" id="studyGroupResultSet">
		<id property="sgNo" column="SG_NO"/>
		<result property="sgName" column="SG_NAME"/>
		<result property="sgGoal" column="SG_GOAL"/>
		<result property="sgContent" column="SG_CONTENT"/>
		<result property="sgStatus" column="SG_STATUS"/>
		<result property="branchNo" column="BRANCH_NO"/>
		<result property="id" column="ID"/>
		<result property="studyNo" column="STUDY_NO"/>
		<result property="studyName" column="STUDY_NAME"/>
		<result property="msgNum" column="MSG_NUM"/>
		<result property="msgRule1" column="MSG_RULE1"/>
		<result property="msgRule2" column="MSG_RULE2"/>
		<result property="msgRule3" column="MSG_RULE3"/>
		<result property="msgMetRule" column="MSG_MET_RULE"/>
		<result property="finalRecDate" column="FINAL_REC_DATE"/>
	</resultMap>
	
	<insert id="insertMultiGroup" parameterType="StudyGroup">
		insert into m_sgroup
		values(#{sgNo}, #{msgNum}, #{msgRule1}, #{msgRule2}, #{msgRule3}, 1, #{msgMetRule})
	</insert>
	
	<update id="updateStudyGroup" parameterType="StudyGroup">
		update sgroup
		set sg_goal=#{sgGoal}, sg_content=#{sgContent}, branch_no=#{branchNo}
		where sg_no=#{sgNo}
	</update>
	
	<update id="updateMultiGroup" parameterType="StudyGroup">
		update m_sgroup
		set msg_num=#{msgNum}, msg_rule1=#{msgRule1}, msg_rule2=#{msgRule2}, msg_rule3=#{msgRule3}, msg_met_rule=#{msgMetRule}
		where sg_no=#{sgNo}
	</update>
</mapper>
